
{
  "project_name": "AI Novel Generator v4 - UI 텍스트 영역 확장",
  "backup_created": false,
  "git_enabled": true,
  "tasks": [
    {
      "step": 1,
      "description": "현재 HTML 구조 분석 및 백업",
      "command": "filesystem.read",
      "parameters": {
        "path": "index.html"
      },
      "expected_result": "현재 HTML 구조 확인 완료",
      "rollback_possible": true,
      "git_commit": {
        "enabled": true,
        "message": "docs: 현재 HTML 구조 분석 완료",
        "description": "- 기존 3분할 레이아웃 구조 파악\n- 백업을 위한 현재 상태 확인"
      }
    },
    {
      "step": 2,
      "description": "기존 CSS 스타일 분석",
      "command": "filesystem.read",
      "parameters": {
        "path": "src/style.css"
      },
      "expected_result": "현재 CSS 그리드 및 레이아웃 스타일 파악",
      "rollback_possible": true,
      "git_commit": {
        "enabled": false,
        "message": "",
        "description": ""
      }
    },
    {
      "step": 3,
      "description": "HTML 구조를 새로운 레이아웃으로 변경",
      "command": "filesystem.write",
      "parameters": {
        "path": "index.html",
        "content": "<!DOCTYPE html>\n<html lang=\"ko\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>AI Novel Generator v4</title>\n    <script src=\"https://cdn.tailwindcss.com\"></script>\n    <link href=\"https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap\" rel=\"stylesheet\">\n    <link rel=\"stylesheet\" href=\"src/style.css\">\n</head>\n<body class=\"bg-gray-900 text-white font-['Noto_Sans_KR']\">\n    <!-- 페이지 로더 -->\n    <div id=\"page-loader\" class=\"fixed inset-0 bg-gray-900 flex items-center justify-center z-50 hidden\">\n        <div class=\"text-center\">\n            <div class=\"animate-spin rounded-full h-16 w-16 border-b-2 border-white mb-4\"></div>\n            <p id=\"page-loader-text\" class=\"text-lg\">로딩 중...</p>\n        </div>\n    </div>\n\n    <!-- 설정 화면 -->\n    <div id=\"setup-screen\" class=\"min-h-screen flex items-center justify-center p-8\">\n        <div class=\"bg-gray-800 rounded-lg p-8 max-w-md w-full\">\n            <h1 class=\"text-3xl font-bold mb-8 text-center\">AI Novel Generator v4</h1>\n            \n            <div class=\"space-y-6\">\n                <div>\n                    <label class=\"block text-sm font-medium mb-2\">장르</label>\n                    <input id=\"genre-input\" type=\"text\" placeholder=\"예: 판타지, SF, 로맨스...\" \n                           class=\"w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:border-blue-500\">\n                </div>\n                \n                <div>\n                    <label class=\"block text-sm font-medium mb-2\">모험 설정</label>\n                    <textarea id=\"adventure-input\" placeholder=\"어떤 모험을 시작하고 싶나요?\" \n                              class=\"w-full p-3 bg-gray-700 rounded-lg border border-gray-600 focus:border-blue-500 h-24 resize-none\"></textarea>\n                </div>\n                \n                <div class=\"space-y-4\">\n                    <button id=\"start-btn\" class=\"w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition-colors\">\n                        모험 시작하기\n                    </button>\n                    \n                    <div class=\"flex gap-2\">\n                        <input type=\"file\" id=\"load-input\" accept=\".json\" class=\"hidden\">\n                        <button id=\"load-btn\" class=\"flex-1 bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 rounded-lg transition-colors\">\n                            이어하기\n                        </button>\n                        \n                        <div class=\"relative\">\n                            <input id=\"api-key-setup-input\" type=\"password\" placeholder=\"Gemini API Key (선택사항)\" \n                                   class=\"w-48 p-2 bg-gray-700 rounded-lg border border-gray-600 focus:border-blue-500 text-sm\">\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <!-- 새로운 메인 게임 화면 -->\n    <div id=\"story-screen\" class=\"hidden h-screen grid-new-layout\">\n        <!-- 메인 컨텐츠 영역 -->\n        <div class=\"main-content-area\">\n            <!-- 텍스트 영역 (빨강) -->\n            <div id=\"text-panel\" class=\"text-area\">\n                <div class=\"flex items-center justify-between mb-4\">\n                    <h2 id=\"scene-title\" class=\"text-2xl font-bold\">장면 제목</h2>\n                    <div class=\"flex gap-2\">\n                        <button id=\"prev-btn\" class=\"px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors disabled:opacity-50\">\n                            ← 이전\n                        </button>\n                        <button id=\"next-btn\" class=\"px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors disabled:opacity-50\">\n                            다음 →\n                        </button>\n                    </div>\n                </div>\n                \n                <div class=\"story-content\">\n                    <div id=\"story-output\" class=\"text-lg leading-relaxed mb-6\">스토리 내용이 여기에 표시됩니다...</div>\n                    \n                    <!-- 선택지들이 텍스트 영역 하단에 표시 -->\n                    <div id=\"choice-container\" class=\"flex flex-col gap-2 mt-4\"></div>\n                </div>\n            </div>\n            \n            <!-- 입력 영역 -->\n            <div class=\"input-section\">\n                <!-- 확장 가능한 텍스트 입력창 (주황) -->\n                <form id=\"story-form\">\n                    <textarea id=\"user-input\" \n                              placeholder=\"행동을 입력하세요... (Enter: 전송, Shift+Enter: 줄바꿈)\" \n                              class=\"text-input w-full p-4 bg-gray-800 border border-gray-700 rounded-lg resize-none focus:border-blue-500 focus:outline-none\"\n                              rows=\"2\"></textarea>\n                </form>\n                \n                <!-- 툴바 + 전송 버튼 영역 -->\n                <div class=\"bottom-toolbar\">\n                    <!-- 툴바 아이콘들 (초록) -->\n                    <div class=\"toolbar-icons\">\n                        <button class=\"toolbar-btn\" data-action=\"inventory\" title=\"인벤토리\">\n                            🎒\n                        </button>\n                        <button class=\"toolbar-btn\" data-action=\"status\" title=\"캐릭터 상태\">\n                            📊\n                        </button>\n                        <button class=\"toolbar-btn\" data-action=\"skills\" title=\"스킬\">\n                            ⚔️\n                        </button>\n                        <button class=\"toolbar-btn\" data-action=\"settings\" title=\"설정\">\n                            ⚙️\n                        </button>\n                    </div>\n                    \n                    <!-- 전송 버튼 (파랑) -->\n                    <button id=\"send-btn\" type=\"submit\" form=\"story-form\" \n                            class=\"send-button bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-semibold transition-colors\">\n                        전송\n                    </button>\n                </div>\n            </div>\n        </div>\n        \n        <!-- 이미지 영역 (회색) -->\n        <div class=\"image-area\">\n            <div class=\"relative h-full\">\n                <img id=\"story-illustration\" src=\"https://placehold.co/800x1200/6b7280/ffffff?text=이미지+생성중\" \n                     alt=\"Story Illustration\" class=\"w-full h-full object-cover rounded-lg\">\n                \n                <!-- 이미지 로더 -->\n                <div id=\"image-loader\" class=\"absolute inset-0 flex items-center justify-center bg-gray-800 bg-opacity-75 rounded-lg hidden\">\n                    <div class=\"text-center\">\n                        <div class=\"animate-spin rounded-full h-12 w-12 border-b-2 border-white mb-4 mx-auto\"></div>\n                        <p id=\"image-loader-text\" class=\"text-sm\">이미지 생성 중...</p>\n                    </div>\n                </div>\n                \n                <!-- 툴바 오버레이 (추후 구현) -->\n                <div id=\"toolbar-overlay\" class=\"absolute inset-0 bg-black bg-opacity-90 backdrop-blur-sm rounded-lg hidden\">\n                    <div class=\"p-6 h-full overflow-y-auto\">\n                        <div class=\"flex items-center justify-between mb-4\">\n                            <h3 id=\"overlay-title\" class=\"text-xl font-bold\">제목</h3>\n                            <button id=\"close-overlay\" class=\"text-gray-400 hover:text-white\">\n                                ✕\n                            </button>\n                        </div>\n                        <div id=\"overlay-content\" class=\"text-gray-300\">\n                            컨텐츠가 여기에 표시됩니다...\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <!-- 기존 요소들 유지 -->\n    <div id=\"past-action-container\" class=\"hidden\">\n        <div class=\"bg-gray-800 p-4 rounded-lg mb-4\">\n            <h3 class=\"text-lg font-semibold mb-2\">이전 행동:</h3>\n            <p id=\"past-action-text\" class=\"text-gray-300\"></p>\n            <button id=\"branch-btn\" class=\"mt-2 px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg\">\n                여기서 다른 선택 하기\n            </button>\n        </div>\n    </div>\n    \n    <div id=\"input-loader\" class=\"loading-overlay hidden\">\n        <div class=\"text-center\">\n            <div class=\"animate-spin rounded-full h-12 w-12 border-b-2 border-white mb-4 mx-auto\"></div>\n            <p id=\"input-loader-text\" class=\"text-lg\">처리 중...</p>\n        </div>\n    </div>\n    \n    <!-- 설정 모달 및 기타 요소들 -->\n    <button id=\"settings-btn-floating\" class=\"fixed top-4 right-4 z-50 bg-gray-800 hover:bg-gray-700 p-3 rounded-full\">\n        ⚙️\n    </button>\n    \n    <div id=\"settings-modal\" class=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden\">\n        <div class=\"bg-gray-800 p-6 rounded-lg max-w-md w-full mx-4\">\n            <h3 class=\"text-xl font-bold mb-4\">설정</h3>\n            \n            <div class=\"space-y-4\">\n                <div>\n                    <label class=\"block text-sm font-medium mb-2\">Gemini API Key</label>\n                    <input id=\"api-key-modal-input\" type=\"password\" \n                           class=\"w-full p-3 bg-gray-700 rounded-lg border border-gray-600\">\n                </div>\n                \n                <div class=\"flex items-center gap-2\">\n                    <input id=\"debug-checkbox\" type=\"checkbox\">\n                    <label for=\"debug-checkbox\">디버그 모드</label>\n                </div>\n                \n                <div class=\"flex gap-2\">\n                    <button id=\"save-btn\" class=\"flex-1 bg-green-600 hover:bg-green-700 py-2 rounded-lg\">\n                        저장하기\n                    </button>\n                    <button id=\"load-modal-btn\" class=\"flex-1 bg-blue-600 hover:bg-blue-700 py-2 rounded-lg\">\n                        불러오기\n                    </button>\n                </div>\n            </div>\n            \n            <button id=\"close-settings-btn\" class=\"mt-4 w-full bg-gray-700 hover:bg-gray-600 py-2 rounded-lg\">\n                닫기\n            </button>\n        </div>\n    </div>\n    \n    <!-- 디버그 요소들 (기존 유지) -->\n    <div id=\"prompt-overlay\" class=\"fixed top-0 left-0 bg-red-600 text-white p-2 text-xs z-40 hidden\"></div>\n    <div id=\"debug-output-container\" class=\"hidden\"></div>\n    \n    <!-- 글로벌 툴팁 -->\n    <div id=\"global-tooltip\" class=\"js-tooltip\"></div>\n    \n    <!-- 이미지 뷰어 모달 -->\n    <div id=\"image-viewer-modal\" class=\"modal-backdrop hidden\">\n        <div class=\"modal-content\">\n            <img id=\"modal-image-content\" src=\"\" alt=\"Full Size Image\" class=\"max-w-full max-h-full\">\n            <button id=\"close-image-viewer\" class=\"absolute top-4 right-4 text-white text-2xl\">&times;</button>\n        </div>\n    </div>\n\n    <!-- 스크립트 로드 -->\n    <script type=\"module\" src=\"src/js/main.js\"></script>\n</body>\n</html>"
      },
      "expected_result": "HTML 구조가 새로운 레이아웃으로 변경됨",
      "rollback_possible": true,
      "git_commit": {
        "enabled": true,
        "message": "feat: 새로운 레이아웃 HTML 구조 구현",
        "description": "- 67:33 분할 그리드 레이아웃으로 변경\n- 텍스트 영역을 67%로 확장\n- 하단 입력 영역 추가 (확장형 입력창 + 툴바 + 전송버튼)\n- 이미지 영역에 툴바 오버레이 준비"
      }
    },
    {
      "step": 4,
      "description": "새로운 레이아웃에 맞는 CSS 스타일 추가",
      "command": "filesystem.write",
      "parameters": {
        "path": "src/style.css",
        "content": "body { font-family: 'Noto Sans KR', sans-serif; overflow: hidden; }\n.input-panel { background: rgba(31, 41, 55, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); transition: background 0.3s ease; }\n.input-panel.focused { background: rgba(31, 41, 55, 0.85); }\n::-webkit-scrollbar { width: 8px; }\n::-webkit-scrollbar-track { background: #1f2937; }\n::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }\n::-webkit-scrollbar-thumb:hover { background: #6b7280; }\n.loading-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10; }\n.modal-backdrop { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); z-index: 40; }\n.modal-content { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 50; }\n\n.js-tooltip {\n    visibility: hidden; position: fixed; background-color: #1f2937; color: #fff; text-align: left;\n    border-radius: 6px; padding: 10px; z-index: 100;\n    opacity: 0; transition: opacity 0.3s; border: 1px solid #4b5563;\n    max-width: 300px; pointer-events: none;\n}\n.js-tooltip.visible { visibility: visible; opacity: 1; }\n\n#settings-btn-floating {\n    position: fixed;\n    top: 1rem;\n    right: 1rem;\n    z-index: 9999; \n}\n\n#story-output {\n     white-space: pre-wrap !important;\n}\n\n#story-screen.loading-outline {\n    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0);\n    animation: pulse-border 1.5s infinite;\n}\n@keyframes pulse-border {\n    0% { box-shadow: 0 0 0 0px rgba(99, 102, 241, 0.7); }\n    100% { box-shadow: 0 0 0 15px rgba(99, 102, 241, 0); }\n}\n\n/* 새로운 레이아웃 스타일 */\n.grid-new-layout {\n    display: grid;\n    grid-template-columns: 2fr 1fr; /* 67% : 33% */\n    grid-template-rows: 1fr;\n    gap: 1rem;\n    padding: 1rem;\n    height: 100vh;\n    box-sizing: border-box;\n}\n\n.main-content-area {\n    display: flex;\n    flex-direction: column;\n    gap: 1rem;\n    min-height: 0;\n}\n\n/* 텍스트 영역 (빨강 영역) */\n.text-area {\n    flex-grow: 1;\n    background: rgba(31, 41, 55, 0.3);\n    border: 1px solid rgba(255, 255, 255, 0.1);\n    border-radius: 12px;\n    padding: 2rem;\n    overflow-y: auto;\n    min-height: 0;\n}\n\n.story-content {\n    display: flex;\n    flex-direction: column;\n    height: 100%;\n}\n\n#story-output {\n    flex-grow: 1;\n    font-size: 1.1rem;\n    line-height: 1.7;\n    margin-bottom: 1rem;\n}\n\n/* 선택지 스타일 */\n#choice-container {\n    margin-top: auto;\n    padding-top: 1rem;\n    border-top: 1px solid rgba(255, 255, 255, 0.1);\n}\n\n#choice-container button {\n    text-align: left;\n    padding: 0.75rem 1rem;\n    background: rgba(99, 102, 241, 0.2);\n    border: 1px solid rgba(99, 102, 241, 0.3);\n    border-radius: 8px;\n    color: white;\n    transition: all 0.2s ease;\n    cursor: pointer;\n}\n\n#choice-container button:hover {\n    background: rgba(99, 102, 241, 0.4);\n    border-color: rgba(99, 102, 241, 0.5);\n    transform: translateX(4px);\n}\n\n/* 입력 영역 */\n.input-section {\n    background: rgba(31, 41, 55, 0.5);\n    border: 1px solid rgba(255, 255, 255, 0.1);\n    border-radius: 12px;\n    padding: 1rem;\n    display: flex;\n    flex-direction: column;\n    gap: 0.75rem;\n}\n\n/* 확장 가능한 텍스트 입력창 (주황) */\n.text-input {\n    min-height: 3rem;\n    max-height: 8rem;\n    font-size: 0.95rem;\n    line-height: 1.4;\n    transition: all 0.2s ease;\n}\n\n.text-input:focus {\n    background: rgba(31, 41, 55, 0.8);\n    border-color: rgba(99, 102, 241, 0.5);\n}\n\n/* 하단 툴바 */\n.bottom-toolbar {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    gap: 1rem;\n}\n\n/* 툴바 아이콘들 (초록) */\n.toolbar-icons {\n    display: flex;\n    gap: 0.5rem;\n}\n\n.toolbar-btn {\n    width: 3rem;\n    height: 3rem;\n    background: rgba(255, 255, 255, 0.1);\n    border: 1px solid rgba(255, 255, 255, 0.2);\n    border-radius: 8px;\n    font-size: 1.2rem;\n    cursor: pointer;\n    transition: all 0.2s ease;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n}\n\n.toolbar-btn:hover {\n    background: rgba(255, 255, 255, 0.2);\n    border-color: rgba(255, 255, 255, 0.3);\n    transform: translateY(-2px);\n}\n\n.toolbar-btn:active {\n    transform: translateY(0);\n}\n\n/* 전송 버튼 (파랑) */\n.send-button {\n    min-width: 5rem;\n    white-space: nowrap;\n}\n\n/* 이미지 영역 (회색) */\n.image-area {\n    background: rgba(107, 114, 128, 0.2);\n    border: 1px solid rgba(255, 255, 255, 0.1);\n    border-radius: 12px;\n    overflow: hidden;\n    position: relative;\n}\n\n.image-area img {\n    transition: opacity 0.3s ease;\n}\n\n/* 툴바 오버레이 */\n#toolbar-overlay {\n    animation: slideInRight 0.3s ease;\n}\n\n#toolbar-overlay.hidden {\n    animation: slideOutRight 0.3s ease;\n}\n\n@keyframes slideInRight {\n    from {\n        transform: translateX(100%);\n        opacity: 0;\n    }\n    to {\n        transform: translateX(0);\n        opacity: 1;\n    }\n}\n\n@keyframes slideOutRight {\n    from {\n        transform: translateX(0);\n        opacity: 1;\n    }\n    to {\n        transform: translateX(100%);\n        opacity: 0;\n    }\n}\n\n/* 반응형 디자인 */\n@media (max-width: 768px) {\n    .grid-new-layout {\n        grid-template-columns: 1fr;\n        grid-template-rows: 1fr auto auto;\n        gap: 0.5rem;\n        padding: 0.5rem;\n    }\n    \n    .main-content-area {\n        grid-row: 1;\n        gap: 0.5rem;\n    }\n    \n    .image-area {\n        grid-row: 2;\n        height: 40vh;\n    }\n    \n    .text-area {\n        padding: 1rem;\n    }\n    \n    .input-section {\n        padding: 0.75rem;\n    }\n    \n    .bottom-toolbar {\n        flex-direction: column;\n        gap: 0.5rem;\n    }\n    \n    .toolbar-icons {\n        order: 2;\n        justify-content: center;\n        width: 100%;\n    }\n    \n    .send-button {\n        order: 1;\n        width: 100%;\n    }\n}\n\n/* 키보드 활성화 상태 (모바일) */\n@media (max-width: 768px) {\n    .keyboard-active .text-area {\n        height: 30vh;\n    }\n    \n    .keyboard-active .image-area {\n        display: none;\n    }\n}"
      },
      "expected_result": "새로운 레이아웃에 맞는 CSS 스타일 적용 완료",
      "rollback_possible": true,
      "git_commit": {
        "enabled": true,
        "message": "style: 새로운 67:33 레이아웃 CSS 구현",
        "description": "- CSS Grid 기반 67:33 분할 레이아웃\n- 텍스트 영역 스타일링 (빨강 영역)\n- 확장 가능한 입력창 스타일 (주황 영역)\n- 툴바 아이콘 스타일 (초록 영역)\n- 전송 버튼 스타일 (파랑 영역)\n- 이미지 영역 및 오버레이 준비\n- 모바일 반응형 대응"
      }
    },
    {
      "step": 5,
      "description": "기존 JavaScript 코드와의 호환성 확인",
      "command": "filesystem.read",
      "parameters": {
        "path": "src/js/dom.js"
      },
    },
    {
      "step": 7,
      "description": "ui.js 파일의 렌더링 로직 수정 필요 부분 확인",
      "command": "filesystem.read",
      "parameters": {
        "path": "src/js/ui.js"
      },
      "expected_result": "UI 렌더링 함수들이 새로운 레이아웃과 호환되는지 확인",
      "rollback_possible": true,
      "git_commit": {
        "enabled": false,
        "message": "",
        "description": ""
      }
    },
    {
      "step": 8,
      "description": "입력창 동적 확장 기능 추가",
      "command": "filesystem.write",
      "parameters": {
        "path": "src/js/input-handler.js",
        "content": "/**\n * 파일명: input-handler.js\n * 목적: 새로운 레이아웃의 입력창 동적 확장 및 툴바 기능 처리\n * 작성일: 2025-09-17\n */\n\nimport * as dom from './dom.js';\nimport * as state from './state.js';\n\n/**\n * 입력창 동적 확장 기능 초기화\n */\nexport function initializeInputHandler() {\n    // 입력창 동적 크기 조절\n    if (dom.userInput) {\n        dom.userInput.addEventListener('input', handleInputResize);\n        dom.userInput.addEventListener('keydown', handleKeyboardShortcuts);\n        \n        // 포커스 이벤트 처리\n        dom.userInput.addEventListener('focus', () => {\n            dom.inputPanel?.classList.add('focused');\n        });\n        \n        dom.userInput.addEventListener('blur', () => {\n            dom.inputPanel?.classList.remove('focused');\n        });\n    }\n    \n    // 툴바 버튼 이벤트 리스너\n    dom.toolbarBtns?.forEach(btn => {\n        btn.addEventListener('click', handleToolbarClick);\n    });\n    \n    // 오버레이 닫기 버튼\n    if (dom.closeOverlay) {\n        dom.closeOverlay.addEventListener('click', hideToolbarOverlay);\n    }\n    \n    // 오버레이 외부 클릭으로 닫기\n    if (dom.toolbarOverlay) {\n        dom.toolbarOverlay.addEventListener('click', (e) => {\n            if (e.target === dom.toolbarOverlay) {\n                hideToolbarOverlay();\n            }\n        });\n    }\n}\n\n/**\n * 입력창 크기 동적 조절\n */\nfunction handleInputResize() {\n    if (!dom.userInput) return;\n    \n    // 높이 초기화\n    dom.userInput.style.height = 'auto';\n    \n    // 스크롤 높이에 맞춰 조절 (최대 높이 제한)\n    const maxHeight = 200; // 8rem 정도\n    const scrollHeight = dom.userInput.scrollHeight;\n    const newHeight = Math.min(scrollHeight, maxHeight);\n    \n    dom.userInput.style.height = newHeight + 'px';\n    \n    // 최대 높이에 도달하면 스크롤 표시\n    if (scrollHeight > maxHeight) {\n        dom.userInput.style.overflowY = 'auto';\n    } else {\n        dom.userInput.style.overflowY = 'hidden';\n    }\n}\n\n/**\n * 키보드 단축키 처리\n */\nfunction handleKeyboardShortcuts(e) {\n    // Enter: 전송 (Shift+Enter: 줄바꿈)\n    if (e.key === 'Enter' && !e.shiftKey) {\n        e.preventDefault();\n        dom.storyForm?.dispatchEvent(new Event('submit'));\n    }\n}\n\n/**\n * 툴바 버튼 클릭 처리\n */\nfunction handleToolbarClick(e) {\n    const action = e.currentTarget.dataset.action;\n    if (!action) return;\n    \n    // 버튼 활성화 표시\n    dom.toolbarBtns?.forEach(btn => {\n        btn.classList.toggle('active', btn === e.currentTarget);\n    });\n    \n    showToolbarOverlay(action);\n}\n\n/**\n * 툴바 오버레이 표시\n */\nfunction showToolbarOverlay(action) {\n    if (!dom.toolbarOverlay || !dom.overlayTitle || !dom.overlayContent) return;\n    \n    // 제목 및 내용 설정\n    const overlayData = getOverlayData(action);\n    dom.overlayTitle.textContent = overlayData.title;\n    dom.overlayContent.innerHTML = overlayData.content;\n    \n    // 오버레이 표시\n    dom.toolbarOverlay.classList.remove('hidden');\n    \n    // 애니메이션을 위한 작은 딜레이\n    setTimeout(() => {\n        dom.toolbarOverlay.style.opacity = '1';\n        dom.toolbarOverlay.style.transform = 'translateX(0)';\n    }, 10);\n}\n\n/**\n * 툴바 오버레이 숨기기\n */\nfunction hideToolbarOverlay() {\n    if (!dom.toolbarOverlay) return;\n    \n    // 애니메이션\n    dom.toolbarOverlay.style.opacity = '0';\n    dom.toolbarOverlay.style.transform = 'translateX(100%)';\n    \n    // 모든 툴바 버튼 비활성화\n    dom.toolbarBtns?.forEach(btn => {\n        btn.classList.remove('active');\n    });\n    \n    // 오버레이 숨기기\n    setTimeout(() => {\n        dom.toolbarOverlay.classList.add('hidden');\n    }, 300);\n}\n\n/**\n * 액션별 오버레이 데이터 반환\n */\nfunction getOverlayData(action) {\n    const overlayContents = {\n        inventory: {\n            title: '🎒 인벤토리',\n            content: `\n                <div class=\"space-y-4\">\n                    <div class=\"text-sm text-gray-400 mb-4\">보유 아이템</div>\n                    <div class=\"grid grid-cols-2 gap-3\">\n                        <div class=\"bg-gray-800 p-3 rounded-lg border border-gray-700\">\n                            <div class=\"text-lg mb-1\">💊</div>\n                            <div class=\"text-sm font-medium\">치유물약</div>\n                            <div class=\"text-xs text-gray-400\">x3</div>\n                        </div>\n                        <div class=\"bg-gray-800 p-3 rounded-lg border border-gray-700\">\n                            <div class=\"text-lg mb-1\">🔮</div>\n                            <div class=\"text-sm font-medium\">마나물약</div>\n                            <div class=\"text-xs text-gray-400\">x1</div>\n                        </div>\n                        <div class=\"bg-gray-900 p-3 rounded-lg border border-gray-800 opacity-50\">\n                            <div class=\"text-lg mb-1\">❓</div>\n                            <div class=\"text-sm font-medium text-gray-500\">빈 슬롯</div>\n                        </div>\n                        <div class=\"bg-gray-900 p-3 rounded-lg border border-gray-800 opacity-50\">\n                            <div class=\"text-lg mb-1\">❓</div>\n                            <div class=\"text-sm font-medium text-gray-500\">빈 슬롯</div>\n                        </div>\n                    </div>\n                    <div class=\"text-xs text-gray-500 mt-4\">\n                        아이템 시스템은 추후 구현 예정입니다.\n                    </div>\n                </div>\n            `\n        },\n        status: {\n            title: '📊 캐릭터 상태',\n            content: `\n                <div class=\"space-y-4\">\n                    <div class=\"text-sm text-gray-400 mb-4\">현재 상태</div>\n                    \n                    <!-- HP 바 -->\n                    <div class=\"space-y-2\">\n                        <div class=\"flex justify-between text-sm\">\n                            <span class=\"text-red-400\">❤️ 생명력</span>\n                            <span>85/100</span>\n                        </div>\n                        <div class=\"w-full bg-gray-700 rounded-full h-3\">\n                            <div class=\"bg-red-500 h-3 rounded-full\" style=\"width: 85%\"></div>\n                        </div>\n                    </div>\n                    \n                    <!-- MP 바 -->\n                    <div class=\"space-y-2\">\n                        <div class=\"flex justify-between text-sm\">\n                            <span class=\"text-blue-400\">💙 마나</span>\n                            <span>60/100</span>\n                        </div>\n                        <div class=\"w-full bg-gray-700 rounded-full h-3\">\n                            <div class=\"bg-blue-500 h-3 rounded-full\" style=\"width: 60%\"></div>\n                        </div>\n                    </div>\n                    \n                    <!-- 기타 스탯 -->\n                    <div class=\"mt-6 space-y-3\">\n                        <div class=\"flex justify-between text-sm\">\n                            <span class=\"text-gray-300\">레벨</span>\n                            <span class=\"text-yellow-400\">5</span>\n                        </div>\n                        <div class=\"flex justify-between text-sm\">\n                            <span class=\"text-gray-300\">경험치</span>\n                            <span class=\"text-green-400\">750/1000</span>\n                        </div>\n                    </div>\n                    \n                    <div class=\"text-xs text-gray-500 mt-6\">\n                        상태 시스템은 추후 구현 예정입니다.\n                    </div>\n                </div>\n            `\n        },\n        skills: {\n            title: '⚔️ 스킬',\n            content: `\n                <div class=\"space-y-4\">\n                    <div class=\"text-sm text-gray-400 mb-4\">사용 가능한 스킬</div>\n                    \n                    <div class=\"space-y-3\">\n                        <div class=\"bg-gray-800 p-3 rounded-lg border border-gray-700\">\n                            <div class=\"flex items-center gap-2 mb-2\">\n                                <span class=\"text-lg\">🔥</span>\n                                <span class=\"font-medium text-orange-400\">파이어볼</span>\n                                <span class=\"text-xs bg-green-600 px-2 py-1 rounded\">사용가능</span>\n                            </div>\n                            <div class=\"text-xs text-gray-400\">기본 화염 마법. 마나 15 소모.</div>\n                        </div>\n                        \n                        <div class=\"bg-gray-800 p-3 rounded-lg border border-gray-700 opacity-60\">\n                            <div class=\"flex items-center gap-2 mb-2\">\n                                <span class=\"text-lg\">💚</span>\n                                <span class=\"font-medium text-green-400\">힐</span>\n                                <span class=\"text-xs bg-red-600 px-2 py-1 rounded\">마나부족</span>\n                            </div>\n                            <div class=\"text-xs text-gray-400\">체력을 회복합니다. 마나 25 소모.</div>\n                        </div>\n                        \n                        <div class=\"bg-gray-900 p-3 rounded-lg border border-gray-800 opacity-40\">\n                            <div class=\"flex items-center gap-2 mb-2\">\n                                <span class=\"text-lg\">❓</span>\n                                <span class=\"font-medium text-gray-500\">잠금됨</span>\n                            </div>\n                            <div class=\"text-xs text-gray-500\">레벨 10에 해제됩니다.</div>\n                        </div>\n                    </div>\n                    \n                    <div class=\"text-xs text-gray-500 mt-6\">\n                        스킬 시스템은 추후 구현 예정입니다.\n                    </div>\n                </div>\n            `\n        },\n        settings: {\n            title: '⚙️ 설정',\n            content: `\n                <div class=\"space-y-4\">\n                    <div class=\"text-sm text-gray-400 mb-4\">게임 설정</div>\n                    \n                    <div class=\"space-y-4\">\n                        <div class=\"flex items-center justify-between\">\n                            <span class=\"text-sm\">디버그 모드</span>\n                            <button class=\"bg-gray-600 hover:bg-gray-500 px-3 py-1 rounded text-xs\">\n                                ${state.isDebugMode ? 'ON' : 'OFF'}\n                            </button>\n                        </div>\n                        \n                        <div class=\"flex items-center justify-between\">\n                            <span class=\"text-sm\">자동 저장</span>\n                            <button class=\"bg-green-600 hover:bg-green-500 px-3 py-1 rounded text-xs\">\n                                ON\n                            </button>\n                        </div>\n                        \n                        <hr class=\"border-gray-700\">\n                        \n                        <div class=\"space-y-2\">\n                            <button class=\"w-full bg-blue-600 hover:bg-blue-700 py-2 px-4 rounded text-sm\">\n                                게임 저장하기\n                            </button>\n                            <button class=\"w-full bg-green-600 hover:bg-green-700 py-2 px-4 rounded text-sm\">\n                                게임 불러오기\n                            </button>\n                        </div>\n                    </div>\n                    \n                    <div class=\"text-xs text-gray-500 mt-6\">\n                        상세 설정은 우상단 ⚙️ 버튼을 이용하세요.\n                    </div>\n                </div>\n            `\n        }\n    };\n    \n    return overlayContents[action] || {\n        title: '알 수 없는 기능',\n        content: '<div class=\"text-center text-gray-500\">준비 중인 기능입니다.</div>'\n    };\n}\n\n// ESC 키로 오버레이 닫기\ndocument.addEventListener('keydown', (e) => {\n    if (e.key === 'Escape' && dom.toolbarOverlay && !dom.toolbarOverlay.classList.contains('hidden')) {\n        hideToolbarOverlay();\n    }\n});"
      },
      "expected_result": "입력창 확장 및 툴바 기능이 구현됨",
      "rollback_possible": true,
      "git_commit": {
        "enabled": true,
        "message": "feat: 입력창 동적 확장 및 툴바 오버레이 기능 구현",
        "description": "- 입력창 자동 크기 조절 기능\n- 툴바 버튼 클릭 시 이미지 위 오버레이 표시\n- 인벤토리, 상태, 스킬, 설정 플레이스홀더 구현\n- ESC 키 및 외부 클릭으로 오버레이 닫기\n- 키보드 단축키 지원"
      }
    },
    {
      "step": 9,
      "description": "main.js에 새로운 입력 핸들러 초기화 코드 추가",
      "command": "filesystem.write",
      "parameters": {
        "path": "src/js/main.js",
        "content": "/**\n * 파일명: main.js\n * 목적: 애플리케이션의 메인 로직, 게임 흐름 제어, 이벤트 리스너 등록을 담당합니다. (v4 아키텍처)\n * 작성일: 2025-09-14\n * \n * === 변경 히스토리 ===\n * 2025-09-14 14:11 - 초기 생성: VV3.md의 핵심 로직과 이벤트 리스너 통합\n * 2025-09-14 14:40 - v4 아키텍처 리팩토링: 2-API 호출, DAD 스냅샷, 작업 큐 로직 적용\n * 2025-09-16 13:50 - 사용자 요구사항에 맞춰 API 재시도 및 오류 처리 로직 전면 개편\n * 2025-09-16 14:00 - 사용자 설계안에 맞춰 이미지 생성(processTask) 로직 전면 재설계\n * 2025-09-16 14:20 - UX 개선: 1차 API 완료 후 즉시 렌더링 및 백그라운드 처리 로직 도입\n * 2025-09-17 - 새로운 레이아웃에 맞게 입력 핸들러 초기화 추가\n * =====================\n */\n\nimport * as dom from './dom.js';\nimport * as state from './state.js';\nimport * as cfg from './config.js';\nimport * as ui from './ui.js';\nimport * as api from './api.js';\nimport * as utils from './utils.js';\nimport { initializeInputHandler } from './input-handler.js';\n\n// --- SECTION: 핵심 게임 흐름 (Orchestrator) (v4) ---\n\nasync function startGame() {\n    try {\n        const genre = dom.genreInput.value;\n        const adventure = dom.adventureInput.value;\n        if (!genre || !adventure) {\n            alert('장르와 모험 내용을 모두 입력해주세요.');\n            return;\n        }\n\n        ui.showPageLoader(\"세계관 구성 중...\");\n        const worldBuildContext = [{ role: \"user\", parts: [{ text: `장르: ${genre}\\n모험: ${adventure}` }] }];\n        \n        const briefJsonResponse = await api.callGenerativeAPI(worldBuildContext, cfg.worldBuilderSystemPrompt, !!state.userApiKey);\n        \n        if (!briefJsonResponse) throw new Error(\"캠페인 생성 AI로부터 응답을 받지 못했습니다.\");\n\n        const initialDadSnapshot = utils.parseCampaignBrief(briefJsonResponse);\n        initialDadSnapshot.genre = genre;\n        initialDadSnapshot.adventure = adventure;\n        state.setInitialDadSnapshot(initialDadSnapshot);\n\n        dom.setupScreen.classList.add('hidden');\n        dom.storyScreen.classList.remove('hidden');\n        dom.storyScreen.classList.add('grid-new-layout');\n\n        await processTurn(`모험이 시작됩니다. 당신은 방금 생성된 세계관에 따라 이야기를 진행해야 합니다. 주인공을 '새로운 핵심 인물'로서 생성하고, 모험을 시작하는 첫 번째 장면을 완성해주세요.`, true);\n\n    } catch (error) {\n        console.error(\"Game start error:\", error);\n        \n        if (error instanceof api.ApiError && !state.userApiKey) {\n            alert(\"API 호출 중 오류가 발생했습니다. 내부 API 사용량이 소진되었을 수 있습니다. 설정 메뉴를 열어 API 키를 입력해주세요.\");\n            dom.settingsModal.classList.remove('hidden');\n        } else {\n            alert(error.message || \"게임 시작 중 오류가 발생했습니다.\");\n        }\n\n        dom.setupScreen.classList.remove('hidden');\n        dom.storyScreen.classList.add('hidden');\n    } finally {\n        ui.hidePageLoader();\n    }\n}\n\nasync function handleUserInput(e) {\n    if (e) e.preventDefault();\n    const text = dom.userInput.value.trim();\n    if (!text || state.isGenerating) return;\n\n    if (state.isBranchingActive) {\n        await handleBranching(state.currentSceneIndex, text);\n        return;\n    }\n\n    dom.userInput.value = '';\n    dom.userInput.style.height = 'auto';\n    ui.clearChoices();\n    await processTurn(text);\n}\n\nasync function handleBranching(branchIndex, userChoice) {\n    state.setSceneArchive(state.sceneArchive.slice(0, branchIndex + 1));\n    state.setCurrentSceneIndex(branchIndex);\n    state.setIsBranchingActive(false);\n    dom.userInput.placeholder = \"다음 행동을 입력하세요... (Enter: 전송, Shift+Enter: 줄바꿈)\";\n\n    dom.userInput.value = '';\n    dom.userInput.style.height = 'auto';\n    ui.clearChoices();\n    await processTurn(userChoice);\n}\n\nexport async function processTurn(userText, isFirstScene = false) {\n    state.setIsGenerating(true);\n    ui.updateGlobalLoadingState();\n\n    try {\n        const previousDadSnapshot = isFirstScene ? state.initialDadSnapshot : state.sceneArchive[state.currentSceneIndex].dadSnapshot;\n\n        const storyContext = buildStoryContext(userText, previousDadSnapshot);\n        const storyResponse = await api.callGenerativeAPI(storyContext, cfg.storyGeneratorSystemPrompt, !!state.userApiKey);\n        if (!storyResponse) throw new Error(\"1차 API(서사 생성)로부터 응답을 받지 못했습니다.\");\n        const { title, story } = utils.parseModelResponse(storyResponse);\n        \n        if (isFirstScene) ui.hidePageLoader();\n\n        const tempSceneData = {\n            user_input: userText,\n            title,\n            story,\n            isComplete: false,\n            dadSnapshot: previousDadSnapshot,\n        };\n\n        if (state.currentSceneIndex < state.sceneArchive.length - 1) {\n            state.setSceneArchive(state.sceneArchive.slice(0, state.currentSceneIndex + 1));\n        }\n        state.sceneArchive.push(tempSceneData);\n        state.setCurrentSceneIndex(state.sceneArchive.length - 1);\n        \n        ui.renderScene(state.currentSceneIndex);\n\n        finishSceneGeneration(state.currentSceneIndex, previousDadSnapshot, story, storyResponse);\n\n    } catch (error) {\n        console.error(\"Turn processing error:\", error);\n        state.setIsGenerating(false);\n        ui.updateGlobalLoadingState();\n        \n        if (error instanceof api.ApiError && !state.userApiKey) {\n            alert(\"API 호출 중 오류가 발생했습니다. 내부 API 사용량이 소진되었을 수 있습니다. 설정 메뉴를 열어 API 키를 입력해주세요.\");\n            dom.settingsModal.classList.remove('hidden');\n        } else {\n            alert(error.message || \"오류가 발생했습니다.\");\n        }\n\n        if (isFirstScene) {\n            dom.setupScreen.classList.remove('hidden');\n            dom.storyScreen.classList.add('hidden');\n        }\n    }\n}\n\nasync function finishSceneGeneration(sceneIndex, previousDadSnapshot, story, storyResponse) {\n    try {\n        const analysisContext = buildAnalysisContext(story, previousDadSnapshot);\n        let analysisResponse;\n        try {\n            analysisResponse = await api.callGenerativeAPI(analysisContext, cfg.analysisSystemPrompt, false);\n        } catch (error) {\n            if (error instanceof api.ApiError && error.status === 429 && state.userApiKey) {\n                console.warn(\"내부 API(분석) 할당량 초과. API 키를 사용하여 재시도합니다.\");\n                analysisResponse = await api.callGenerativeAPI(analysisContext, cfg.analysisSystemPrompt, true);\n            } else {\n                throw error;\n            }\n        }\n        if (!analysisResponse) throw new Error(\"2차 API(분석)로부터 응답을 받지 못했습니다.\");\n        const analysisResult = utils.parseModelResponse(analysisResponse);\n\n        const newDadSnapshot = mergeDadSnapshot(previousDadSnapshot, analysisResult.newAssets);\n\n        await executeTaskQueue(analysisResult.taskQueue, newDadSnapshot);\n\n        const finalSceneData = {\n            ...state.sceneArchive[sceneIndex],\n            hints: analysisResult.hints,\n            choices: analysisResult.choices,\n            displayImageId: analysisResult.displayImageId,\n            dadSnapshot: newDadSnapshot,\n            raw_story_response: storyResponse,\n            raw_analysis_response: analysisResponse,\n            taskQueue: analysisResult.taskQueue,\n            isComplete: true,\n        };\n        state.sceneArchive[sceneIndex] = finalSceneData;\n\n    } catch (error) {\n        console.error(\"Background scene generation error:\", error);\n        state.sceneArchive[sceneIndex].error = true;\n    } finally {\n        state.setIsGenerating(false);\n        if (state.currentSceneIndex === sceneIndex) {\n            ui.renderScene(sceneIndex);\n        }\n        ui.updateGlobalLoadingState();\n    }\n}\n\nfunction buildStoryContext(currentUserAction, dadSnapshot) {\n    const narrativeContext = buildNarrativeContext();\n    return [\n        { role: \"user\", parts: [{ text: JSON.stringify({ dynamicAssetDatabase: dadSnapshot, narrativeContext, currentUserAction }) }] }\n    ];\n}\n\nfunction buildAnalysisContext(storyForAnalysis, dadSnapshot) {\n    const recentStoryContext = state.sceneArchive.slice(-2).map(scene => scene.story);\n    return [\n        { role: \"user\", parts: [{ text: JSON.stringify({ dynamicAssetDatabase: dadSnapshot, storyForAnalysis, recentStoryContext }) }] }\n    ];\n}\n\nfunction buildNarrativeContext() {\n    const shortTermMemoryCount = 4;\n    let history = [];\n\n    if (state.sceneArchive.length > 0) {\n        const longTermScenes = state.sceneArchive.slice(0, -shortTermMemoryCount);\n        const shortTermScenes = state.sceneArchive.slice(-shortTermMemoryCount);\n\n        if (longTermScenes.length > 0) {\n            const longTermStorySummary = longTermScenes.map((scene, i) => `[SCENE ${i + 1} STORY]:\\n${scene.story}`).join('\\n\\n');\n            history.push({ role: \"user\", parts: [{ text: `[LONG_TERM_MEMORY_SUMMARY]\\n${longTermStorySummary}` }] });\n            history.push({ role: \"model\", parts: [{ text: \"알겠습니다. 장기 기억(이전 이야기들)을 확인했습니다.\" }] });\n        }\n\n        shortTermScenes.forEach(scene => {\n            history.push({ role: \"user\", parts: [{ text: scene.user_input }] });\n            if(scene.raw_analysis_response) history.push({ role: \"model\", parts: [{ text: scene.raw_analysis_response }] });\n        });\n    }\n    return history;\n}\n\nfunction mergeDadSnapshot(previousSnapshot, newAssets) {\n    const newSnapshot = JSON.parse(JSON.stringify(previousSnapshot));\n    if (!newAssets) return newSnapshot;\n\n    const merge = (targetArray, sourceArray) => {\n        if (!sourceArray || !Array.isArray(sourceArray)) return;\n        sourceArray.forEach(newItem => {\n            const existingIndex = targetArray.findIndex(item => item.id === newItem.id);\n            if (existingIndex > -1) {\n                targetArray[existingIndex] = { ...targetArray[existingIndex], ...newItem };\n            } else {\n                targetArray.push(newItem);\n            }\n        });\n    };\n\n    merge(newSnapshot.keyCharacters, newAssets.keyCharacters);\n    merge(newSnapshot.keyItems, newAssets.keyItems);\n    merge(newSnapshot.keyLocations, newAssets.keyLocations);\n    merge(newSnapshot.keySkills, newAssets.keySkills);\n\n    return newSnapshot;\n}\n\nasync function executeTaskQueue(taskQueue, dadSnapshot) {\n    if (!taskQueue || taskQueue.length === 0) return;\n\n    const keyVisualTask = taskQueue.find(t => t.type === 'key_visual');\n    if (keyVisualTask && !state.imageCache.has(keyVisualTask.assetId)) {\n        await processTask(keyVisualTask, dadSnapshot);\n    }\n\n    for (const task of taskQueue) {\n        if (task.type !== 'key_visual') {\n            const imageCacheKey = `${task.assetId}_${task.type}`;\n            if (!state.imageCache.has(imageCacheKey)) {\n                await processTask(task, dadSnapshot);\n            }\n        }\n    }\n}\n\nasync function processTask(task, dadSnapshot) {\n    const imageCacheKey = task.type === 'key_visual' ? task.assetId : `${task.assetId}_${task.type}`;\n    \n    const promptTemplate = cfg.promptTemplates[task.type];\n    if (!promptTemplate) {\n        console.warn(`알 수 없는 작업 유형: ${task.type}`);\n        return;\n    }\n\n    let promptData = { ...promptTemplate };\n    const referenceImages = [];\n    \n    switch (task.type) {\n        case 'key_visual':\n            promptData.data_payload = dadSnapshot;\n            break;\n\n        case '3_view_reference':\n            promptData.data_payload = dadSnapshot.keyCharacters.find(c => c.id === task.assetId) || dadSnapshot.keyItems.find(i => i.id === task.assetId) || {};\n            if (state.imageCache.has('campaign_key_visual')) {\n                referenceImages.push({ id: 'campaign_key_visual', base64Data: state.imageCache.get('campaign_key_visual').split(',')[1] });\n            }\n            break;\n\n        case 'head_portrait':\n            promptData.data_payload = dadSnapshot.keyCharacters.find(c => c.id === task.assetId) || {};\n            if (state.imageCache.has('campaign_key_visual')) {\n                referenceImages.push({ id: 'campaign_key_visual', base64Data: state.imageCache.get('campaign_key_visual').split(',')[1] });\n            }\n            const threeViewCacheKey = `${task.assetId}_3_view_reference`;\n            if (state.imageCache.has(threeViewCacheKey)) {\n                 referenceImages.push({ id: threeViewCacheKey, base64Data: state.imageCache.get(threeViewCacheKey).split(',')[1] });\n            }\n            break;\n\n        case 'illustration':\n            promptData.scene_text_payload = state.sceneArchive[state.currentSceneIndex].story;\n            promptData.data_payload = { dadSnapshot };\n            \n            if (state.imageCache.has('campaign_key_visual')) {\n                 referenceImages.push({ id: 'campaign_key_visual', base64Data: state.imageCache.get('campaign_key_visual').split(',')[1] });\n            }\n\n            const currentTaskQueue = state.sceneArchive[state.currentSceneIndex].taskQueue || [];\n            currentTaskQueue.forEach(t => {\n                const assetCacheKey = `${t.assetId}_${t.type}`;\n                if (t.type === '3_view_reference' && state.imageCache.has(assetCacheKey)) {\n                    referenceImages.push({ id: assetCacheKey, base64Data: state.imageCache.get(assetCacheKey).split(',')[1] });\n                }\n            });\n            break;\n    }\n\n    try {\n        let imageUrl = await api.callImageAPI(promptData, referenceImages, false);\n        state.imageCache.set(imageCacheKey, imageUrl);\n    } catch (error) {\n        if (error instanceof api.ApiError && error.status === 429 && state.userApiKey) {\n            console.warn(`내부 이미지 API 할당량 초과 (${task.assetId}). API 키를 사용하여 재시도합니다.`);\n            try {\n                const imageUrl = await api.callImageAPI(promptData, referenceImages, true);\n                state.imageCache.set(imageCacheKey, imageUrl);\n            } catch (retryError) {\n                 console.error(`Image API retry failed for task: ${task.assetId}`, retryError);\n                 state.imageCache.set(imageCacheKey, \"https://placehold.co/1200x1800/ff0000/FFF?text=Gen+Failed\");\n            }\n        } else {\n            console.error(`Failed to generate image for task: ${task.assetId}`, error);\n            state.imageCache.set(imageCacheKey, \"https://placehold.co/1200x1800/ff0000/FFF?text=Gen+Failed\");\n            if (error instanceof api.ApiError && !state.userApiKey) {\n                 alert(\"이미지 생성 중 오류가 발생했습니다. 내부 API 사용량이 소진되었을 수 있습니다. 설정에서 API 키를 입력하시면 계속할 수 있습니다.\");\n                 dom.settingsModal.classList.remove('hidden');\n            }\n        }\n    }\n}\n\n// --- SECTION: 이벤트 리스너 등록 (v4) ---\n\nfunction initializeEventListeners() {\n    dom.startBtn.addEventListener('click', startGame);\n    dom.loadBtn.addEventListener('click', () => dom.loadInput.click());\n    dom.loadInput.addEventListener('change', utils.handleFileLoad);\n\n    dom.prevBtn.addEventListener('click', () => { if (state.currentSceneIndex > 0) ui.renderScene(state.currentSceneIndex - 1); });\n    dom.nextBtn.addEventListener('click', () => { if (state.currentSceneIndex < state.sceneArchive.length - 1) ui.renderScene(state.currentSceneIndex + 1); });\n\n    dom.storyForm.addEventListener('submit', handleUserInput);\n    \n    dom.settingsBtnFloating.addEventListener('click', () => dom.settingsModal.classList.remove('hidden'));\n    dom.closeSettingsBtn.addEventListener('click', () => dom.settingsModal.classList.add('hidden'));\n    dom.debugCheckbox.addEventListener('change', () => {\n        state.setIsDebugMode(dom.debugCheckbox.checked);\n        if (state.currentSceneIndex >= 0) ui.toggleDebugView(state.isDebugMode);\n    });\n    dom.saveBtn.addEventListener('click', utils.saveStory);\n    dom.loadModalBtn.addEventListener('click', () => { dom.loadInput.click(); dom.settingsModal.classList.add('hidden'); });\n\n    const syncApiKeys = (e) => {\n        state.setUserApiKey(e.target.value);\n        dom.apiKeyModalInput.value = state.userApiKey;\n        dom.apiKeySetupInput.value = state.userApiKey;\n    };\n    dom.apiKeySetupInput.addEventListener('input', syncApiKeys);\n    dom.apiKeyModalInput.addEventListener('input', syncApiKeys);\n\n    dom.branchBtn.addEventListener('click', () => {\n        state.setIsBranchingActive(true);\n        ui.renderScene(state.currentSceneIndex);\n        dom.userInput.placeholder = \"다른 선택지를 고르거나, 새로운 행동을 입력하세요.\";\n    });\n\n    const closeImageViewer = () => dom.imageViewerModal.classList.add('hidden');\n    dom.closeImageViewerBtn.addEventListener('click', closeImageViewer);\n    dom.imageViewerModal.addEventListener('click', (e) => {\n        if (e.target.id === 'image-viewer-modal') closeImageViewer();\n    });\n\n    window.addEventListener('keydown', (e) => {\n        const isModalOpen = !dom.settingsModal.classList.contains('hidden');\n        const isInputFocused = document.activeElement === dom.userInput;\n\n        if (e.key === 'Escape') {\n            e.preventDefault();\n            if (!dom.imageViewerModal.classList.contains('hidden')) {\n                closeImageViewer();\n            } else if (state.isBranchingActive) {\n                state.setIsBranchingActive(false);\n                ui.renderScene(state.currentSceneIndex);\n            } else {\n                dom.settingsModal.classList.toggle('hidden');\n            }\n        }\n\n        if (isInputFocused || isModalOpen) return;\n\n        if (e.key === 'ArrowLeft') { dom.prevBtn.click(); }\n        if (e.key === 'ArrowRight') { dom.nextBtn.click(); }\n\n        if (e.key === 'ArrowUp') { document.querySelector('#story-panel .flex-grow')?.scrollBy(0, -50); }\n        if (e.key === 'ArrowDown') { document.querySelector('#story-panel .flex-grow')?.scrollBy(0, 50); }\n\n        if (e.ctrlKey && e.key === 'ArrowDown') { e.preventDefault(); dom.userInput.focus(); }\n        if (e.ctrlKey && e.key === 'ArrowUp') { e.preventDefault(); dom.prevBtn.focus(); }\n    });\n}\n\n// --- SECTION: 애플리케이션 초기화 ---\n\nwindow.addEventListener('DOMContentLoaded', () => {\n    initializeEventListeners();\n    initializeInputHandler(); // 새로운 입력 핸들러 초기화\n});"
      },
      "expected_result": "main.js에 새로운 입력 핸들러 초기화 완료",
      "rollback_possible": true,
      "git_commit": {
        "enabled": true,
        "message": "feat: main.js에 새로운 입력 핸들러 통합",
        "description": "- input-handler.js 모듈 임포트 및 초기화\n- 기존 이벤트 리스너와 호환성 유지\n- DOMContentLoaded 시 입력 핸들러 자동 초기화"
      }
    },
    {
      "step": 10,
      "description": "레이아웃 변경 완료 확인",
      "command": "shell.run",
      "parameters": {
        "command": "echo 'Phase 1: UI 레이아웃 구조 변경 완료!\n\n✅ 구현된 기능:\n1. 67:33 분할 레이아웃 (텍스트 영역 2배 확장)\n2. 하단 입력 영역 (확장형 입력창 + 툴바 + 전송버튼)\n3. 동적 입력창 크기 조절\n4. 툴바 버튼 클릭시 이미지 위 오버레이\n5. 반응형 모바일 레이아웃\n6. ESC키 및 키보드 단축키 지원\n\n🚀 테스트 방법:\n- 브라우저에서 index.html 열기\n- 텍스트 영역이 화면의 67% 차지 확인\n- 입력창에 긴 텍스트 입력시 자동 확장 확인\n- 🎒📊⚔️⚙️ 툴바 버튼 클릭시 오버레이 표시 확인\n- 모바일 화면에서 세로 스택 레이아웃 확인\n\n📋 다음 단계 (Phase 2):\n- 선택지를 텍스트 영역 하단에 표시하는 기능 구현\n- 기존 JavaScript 로직과의 완전한 호환성 확보'"
      },
      "expected_result": "레이아웃 변경 작업 완료 확인 및 다음 단계 안내",
      "rollback_possible": false,
      "git_commit": {
        "enabled": true,
        "message": "feat: Phase 1 - UI 레이아웃 구조 변경 완료",
        "description": "- 67:33 분할 그리드 레이아웃 구현\n- 텍스트 영역 2배 확장 (33% → 67%)\n- 동적 입력창 및 툴바 오버레이 시스템\n- 반응형 디자인 적용\n- 기존 코드와의 호환성 유지\n- Phase 2 준비 완료"
      }
    }
  ]
}